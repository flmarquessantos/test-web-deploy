name: Deploy TEST-WEB to IIS (EC2 via SSM)

on:
  push:
    branches: ["main"]
    paths:
      - "site/**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Zip site
        shell: pwsh
        run: |
          $stamp = Get-Date -Format "yyyy-MM-dd_HHmmss"
          $zip = "test-web_$stamp.zip"
          Compress-Archive -Path "site\*" -DestinationPath $zip -Force
          "ZIP_NAME=$zip" | Out-File -FilePath $env:GITHUB_ENV -Append
          "S3_KEY=test-web/$zip" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload ZIP to S3
        shell: pwsh
        run: |
          aws s3 cp "${{ env.ZIP_NAME }}" "s3://${{ secrets.S3_BUCKET }}/${{ env.S3_KEY }}"

      - name: Deploy via AWS SSM
        shell: pwsh
        run: |
          $commands = @(
            '$ErrorActionPreference = "Stop"',
            'Import-Module WebAdministration',

            # Ajuste aqui se mudar:
            '$SitePath = "C:\Sites\test-web"',
            '$AppPool  = "test-web"',
            '$offline  = Join-Path $SitePath "app_offline.htm"',

            'New-Item -ItemType Directory -Force -Path "C:\Deploy\temp"   | Out-Null',
            'New-Item -ItemType Directory -Force -Path "C:\Deploy\backup" | Out-Null',

            '$stamp  = Get-Date -Format "yyyyMMdd_HHmmss"',
            '$temp   = Join-Path "C:\Deploy\temp"   $stamp',
            '$backup = Join-Path "C:\Deploy\backup" $stamp',
            'New-Item -ItemType Directory -Force -Path $temp   | Out-Null',
            'New-Item -ItemType Directory -Force -Path $backup | Out-Null',

            # Backup do site atual
            'robocopy $SitePath $backup /MIR /R:2 /W:2 /NFL /NDL /NP | Out-Null',
            'Get-ChildItem "C:\Deploy\backup" | Sort-Object CreationTime -Descending | Select-Object -Skip 10 | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue',

            # Baixa ZIP
            '$zip     = Join-Path $temp "package.zip"',
            '$extract = Join-Path $temp "extract"',
            'New-Item -ItemType Directory -Force -Path $extract | Out-Null',

            '$awsExe = "C:\Program Files\Amazon\AWSCLIV2\aws.exe"',
            'if (-not (Test-Path $awsExe)) { $awsExe = "aws.exe" }',
            '$s3uri = "s3://${{ secrets.S3_BUCKET }}/${{ env.S3_KEY }}"',
            'Start-Process -FilePath $awsExe -ArgumentList @("s3","cp",$s3uri,$zip) -Wait -NoNewWindow',
            'if (-not (Test-Path $zip)) { throw "ZIP nao foi baixado do S3: $s3uri" }',

            'Expand-Archive -Path $zip -DestinationPath $extract -Force',

            # Deploy
            '"Deploy em andamento ($stamp)" | Out-File -Encoding utf8 $offline',
            'Stop-WebAppPool -Name $AppPool',
            'robocopy $extract $SitePath /MIR /R:2 /W:2 /NFL /NDL /NP | Out-Null',
            'Start-WebAppPool -Name $AppPool',
            'Remove-Item $offline -Force -ErrorAction SilentlyContinue',
            'Write-Host "Deploy finished. Backup em: C:\Deploy\backup\$stamp"'
          )

          $payload = @{
            DocumentName = "AWS-RunPowerShellScript"
            InstanceIds  = @("${{ secrets.INSTANCE_ID }}")
            Comment      = "Deploy TEST-WEB from GitHub Actions"
            Parameters   = @{ commands = $commands }
          } | ConvertTo-Json -Compress

          aws ssm send-command --cli-input-json $payload
