name: Deploy TEST-WEB to IIS (EC2 via SSM)

on:
  push:
    branches: ["main"]
    paths:
      - "site/**"
      - ".github/workflows/deploy.yml"
  workflow_dispatch:

jobs:
  deploy:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Zip site
        shell: pwsh
        run: |
          $stamp = Get-Date -Format "yyyy-MM-dd_HHmmss"
          $zip = "test-web_$stamp.zip"
          Compress-Archive -Path "site\*" -DestinationPath $zip -Force
          "ZIP_NAME=$zip" | Out-File -FilePath $env:GITHUB_ENV -Append
          "S3_KEY=test-web/$zip" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: AWS creds
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Upload to S3
        shell: pwsh
        run: |
          aws s3 cp "${{ env.ZIP_NAME }}" "s3://${{ secrets.S3_BUCKET }}/${{ env.S3_KEY }}"

      - name: Deploy via SSM
        shell: pwsh
        run: |
          $SitePath = 'C:\Sites\test-web'
          $AppPool  = 'test-web'

          $commands = @(
            '$ErrorActionPreference="Stop"',
            'Import-Module WebAdministration',
            'New-Item -ItemType Directory -Force -Path "C:\Deploy\temp" | Out-Null',
            '$stamp = Get-Date -Format "yyyyMMdd_HHmmss"',
            '$temp = "C:\Deploy\temp\" + $stamp',
            'New-Item -ItemType Directory -Force -Path $temp | Out-Null',
            '$zip = Join-Path $temp "package.zip"',
            '$extract = Join-Path $temp "extract"',
            'New-Item -ItemType Directory -Force -Path $extract | Out-Null',
            'aws s3 cp "s3://${{ secrets.S3_BUCKET }}/${{ env.S3_KEY }}" $zip',
            'Expand-Archive -Path $zip -DestinationPath $extract -Force',
            '"Deploy em andamento ($stamp)" | Out-File -Encoding utf8 (Join-Path "' + $SitePath + '" "app_offline.htm")',
            'Stop-WebAppPool -Name "' + $AppPool + '"',
            'robocopy $extract "' + $SitePath + '" /MIR /R:2 /W:2 /NFL /NDL /NP | Out-Null',
            'Start-WebAppPool -Name "' + $AppPool + '"',
            'Remove-Item (Join-Path "' + $SitePath + '" "app_offline.htm") -Force -ErrorAction SilentlyContinue',
            'Write-Host "Deploy finished."'
          )

          $params = @{ commands = $commands } | ConvertTo-Json -Compress

          aws ssm send-command `
            --instance-ids "i-0ff3eed394d63c2c
